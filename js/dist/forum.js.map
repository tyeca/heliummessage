{"version":3,"sources":["webpack://@kyrne/whisper/webpack/bootstrap","webpack://@kyrne/whisper/external \"flarum.core.compat['Model']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/username']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/Stream']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['app']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/avatar']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['Component']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/mixin']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/Button']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/withAttr']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['extend']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/Page']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/LoadingIndicator']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/IndexPage']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['models/User']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/classList']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/humanTime']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/icon']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/userOnline']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/Modal']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/Search']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['helpers/highlight']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/ItemList']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/extractText']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['utils/extract']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/HeaderSecondary']\"","webpack://@kyrne/whisper/external \"flarum.core.compat['components/NotificationsDropdown']\"","webpack://@kyrne/whisper/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://@kyrne/whisper/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://@kyrne/whisper/./src/forum/models/Message.js","webpack://@kyrne/whisper/./src/forum/models/Conversation.js","webpack://@kyrne/whisper/./src/forum/models/ConversationUser.js","webpack://@kyrne/whisper/./src/forum/components/MessageText.js","webpack://@kyrne/whisper/./src/forum/components/ConversationView.js","webpack://@kyrne/whisper/./src/forum/components/UserListItem.js","webpack://@kyrne/whisper/./src/forum/components/UserSearchSource.js","webpack://@kyrne/whisper/./src/forum/components/RecipientSearch.js","webpack://@kyrne/whisper/./src/forum/components/recipientLabel.js","webpack://@kyrne/whisper/./src/forum/components/StartConversationModal.js","webpack://@kyrne/whisper/./src/forum/components/ConversationsList.js","webpack://@kyrne/whisper/./src/forum/components/ConversationsPage.js","webpack://@kyrne/whisper/./src/forum/components/ConversationViewPage.js","webpack://@kyrne/whisper/./src/forum/components/ConversationsDropdown.js","webpack://@kyrne/whisper/./src/forum/index.js","webpack://@kyrne/whisper/./src/forum/addConversationsDropdown.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","flarum","core","compat","_setPrototypeOf","setPrototypeOf","__proto__","_inheritsLoose","subClass","superClass","constructor","Message","apiEndpoint","this","exists","data","id","mixin","Model","message","attribute","user","hasOne","isHidden","createdAt","transformDate","conversation","number","Conversation","messages","hasMany","recipients","totalMessages","notNew","updatedAt","ConversationUser","userId","conversationId","lastRead","MessageText","initAttrs","attrs","className","content","preview","view","oncreate","vnode","updatePreview","s9e","TextFormatter","dom","updateInterval","setInterval","onremove","clearInterval","Component","ConversationView","oninit","loading","mobile","idParam","route","param","firstLoad","typingTimeout","sendTimeout","interval3","timer","redraw","setTimeout","interval1","interval2","typingTime","Date","now","typing","initPost","newMessageCount","load","messageContent","Stream","Promise","$","animate","scrollTop","prop","app","pusher","then","channels","unbind","onupdate","scroll","firstMsg","getMessages","cache","length","offset","top","onbeforeupdate","on","e","conversations","currentTarget","attr","index","cipher","off","keyCode","forum","sendMessage","parseInt","children","is","decryptMessages","list","scrollMore","innerHeight","scrollHeight","recipient","style","avatar","translator","trans","username","count","filter","self","findIndex","sort","a","b","map","myMessage","session","humanTime","attributes","icon","display","size","oninput","withAttr","typingPush","placeholder","rows","Button","component","onclick","disabled","request","method","url","body","replace","store","createRecord","save","messageContents","push","messageId","find","results","payload","oldNumber","meRecipient","response","newNumber","pushAttributes","unreadMessages","UserListItem","active","userOnline","UserSearchSource","query","conversationResults","highlight","text","data-index","q","page","limit","pushResults","result","getById","RecipientSearch","$search","target","addRecipient","focus","parentNode","clearTimeout","typingTimer","doSearch","sources","sourceItems","toArray","conversationsRecipient","classList","open","focused","loadingSources","config","element","type","extractText","onfocus","hasFocus","onblur","in","source","LoadingIndicator","link","extract","recipientLabel","removeRecipient","items","ItemList","add","clear","findRecipient","Search","StartConversationModal","already","title","ev","stopImmediatePropagation","recpient","class","state","search","onsubmit","preventDefault","input","document","createElement","appendChild","select","execCommand","remove","preconv","modal","close","Modal","ConversationsList","currentConversation","loadMore","conversationComponent","showModal","show","ConversationsPage","history","bodyClass","Page","ConversationViewPage","init","ConversationsDropdown","label","drawer","isOpen","goToRoute","getMenu","menuClassName","showing","getUnreadCount","getNewCount","NotificationsDropdown","initializers","models","conversation_users","User","routes","path","extend","HeaderSecondary","IndexPage"],"mappings":"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","file":"forum.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 26);\n","module.exports = flarum.core.compat['Model'];","module.exports = flarum.core.compat['helpers/username'];","module.exports = flarum.core.compat['utils/Stream'];","module.exports = flarum.core.compat['app'];","module.exports = flarum.core.compat['helpers/avatar'];","module.exports = flarum.core.compat['Component'];","module.exports = flarum.core.compat['utils/mixin'];","module.exports = flarum.core.compat['components/Button'];","module.exports = flarum.core.compat['utils/withAttr'];","module.exports = flarum.core.compat['extend'];","module.exports = flarum.core.compat['components/Page'];","module.exports = flarum.core.compat['components/LoadingIndicator'];","module.exports = flarum.core.compat['components/IndexPage'];","module.exports = flarum.core.compat['models/User'];","module.exports = flarum.core.compat['utils/classList'];","module.exports = flarum.core.compat['helpers/humanTime'];","module.exports = flarum.core.compat['helpers/icon'];","module.exports = flarum.core.compat['helpers/userOnline'];","module.exports = flarum.core.compat['components/Modal'];","module.exports = flarum.core.compat['components/Search'];","module.exports = flarum.core.compat['helpers/highlight'];","module.exports = flarum.core.compat['utils/ItemList'];","module.exports = flarum.core.compat['utils/extractText'];","module.exports = flarum.core.compat['utils/extract'];","module.exports = flarum.core.compat['components/HeaderSecondary'];","module.exports = flarum.core.compat['components/NotificationsDropdown'];","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n\n  return _setPrototypeOf(o, p);\n}","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","import Model from 'flarum/Model';\nimport mixin from 'flarum/utils/mixin';\n\nexport default class Message extends mixin(Model, {\n    message: Model.attribute('message'),\n    user: Model.hasOne('user'),\n    isHidden: Model.attribute('isHidden'),\n    createdAt: Model.attribute('createdAt', Model.transformDate),\n    conversation: Model.hasOne('conversation'),\n    number: Model.hasOne('number'),\n}) {\n  apiEndpoint() {\n    return `/whisper/messages${this.exists ? `/${this.data.id}` : ''}`;\n  }\n}\n","import Model from 'flarum/Model';\nimport mixin from 'flarum/utils/mixin';\n\nexport default class Conversation extends mixin(Model, {\n  messages: Model.hasMany('messages'),\n  recipients: Model.hasMany('recipients'),\n  totalMessages: Model.attribute('totalMessages'),\n  notNew: Model.attribute('notNew'),\n  createdAt: Model.attribute('createdAt', Model.transformDate),\n  updatedAt: Model.attribute('updatedAt', Model.transformDate),\n}) {\n  apiEndpoint() {\n    return `/whisper/conversations${this.exists ? `/${this.data.id}` : ''}`;\n  }\n}\n","import Model from 'flarum/Model';\nimport mixin from 'flarum/utils/mixin';\n\nexport default class ConversationUser extends mixin(Model, {\n  conversation: Model.hasOne('conversation'),\n  user: Model.hasOne('user'),\n\n  userId: Model.attribute('userId'),\n  conversationId: Model.attribute('conversationId'),\n  lastRead: Model.attribute('lastRead')\n}) {}\n","import Component from 'flarum/Component';\n\nexport default class MessageText extends Component {\n  static initAttrs(attrs) {\n    attrs.className = attrs.className || '';\n    attrs.content = attrs.content || '';\n    attrs.preview = attrs.preview || false;\n  }\n\n  view() {\n    return <div className={this.attrs.className} />;\n  }\n\n  oncreate(vnode) {\n    super.oncreate(vnode);\n\n    if (this.attrs.preview) {\n\n      let preview;\n      const updatePreview = () => {\n\n        const content = this.attrs.content;\n\n        if (preview === content) return;\n\n        preview = content;\n\n        s9e.TextFormatter.preview(content || '', vnode.dom);\n      };\n      updatePreview();\n\n      this.updateInterval = setInterval(updatePreview, 50);\n    } else {\n      s9e.TextFormatter.preview(this.attrs.content, vnode.dom);\n    }\n  }\n\n  onremove() {\n    clearInterval(this.updateInterval);\n  }\n}\n","import Component from 'flarum/Component';\nimport Button from 'flarum/components/Button';\nimport avatar from 'flarum/helpers/avatar';\nimport username from 'flarum/helpers/username';\nimport humanTime from 'flarum/helpers/humanTime'\nimport LoadingIndicator from 'flarum/components/LoadingIndicator';\nimport MessageText from \"./MessageText\";\nimport Stream from 'flarum/utils/Stream';\nimport withAttr from 'flarum/utils/withAttr';\nimport icon from 'flarum/helpers/icon';\n\nexport default class ConversationView extends Component {\n  oninit(vnode) {\n    this.loading = true;\n    this.vnode = vnode;\n    this.mobile = vnode.attrs.mobile;\n    this.idParam = m.route.param('id');\n    this.firstLoad = true;\n\n    this.typingTimeout = true;\n\n    this.sendTimeout = true;\n\n    const interval1 = () => {\n      this.typingTimeout = true;\n      setTimeout(() => {\n        interval1();\n      }, 5000);\n    };\n\n    const interval2 = () => {\n      if (this.typingTime < new Date(Date.now() - 6000)) {\n        this.typing = false;\n        m.redraw();\n      }\n      setTimeout(() => {\n        interval2();\n      }, 6000);\n    };\n\n    this.interval3 = () => {\n      if (this.timer === 0) {\n        this.sendTimeout = true;\n        m.redraw();\n        return;\n      }\n      this.timer--;\n      if (this.timer >= 0) {\n        setTimeout(() => {\n          this.interval3();\n        }, 1000);\n      }\n    };\n\n    interval1();\n    interval2();\n\n    this.typing = false;\n\n    this.conversation = this.conversation ? this.conversation : vnode.attrs.conversation;\n\n    this.initPost();\n  }\n\n  initPost() {\n    this.newMessageCount = 0;\n\n    this.load();\n\n    this.messageContent = Stream('');\n\n    return new Promise(() => {\n      setTimeout(() => {\n        $(\".chat-history\").animate({scrollTop: $('.chat-history').prop(\"scrollHeight\")}, 1000);\n      }, 500);\n    });\n  }\n\n  onremove() {\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        channels.user.unbind('typing');\n        channels.user.unbind('newMessage');\n      });\n    }\n  }\n\n  onupdate() {\n\n    $('.chat-history').scroll(() => {\n      if (!this.notNew) {\n        let pos = $('.chat-history').scrollTop();\n        if (pos === 0) {\n          const firstMsg = $('.message-content:first');\n          this.getMessages(app.cache.messages[this.conversation.id()].length);\n          if (!this.notNew) {\n            $('.chat-history').scrollTop(firstMsg.offset().top);\n          }\n        }\n      }\n    });\n  }\n\n  onbeforeupdate() {\n\n    $('.UserListItem').on('click', ((e) => {\n      this.conversation = app.cache.conversations[$(e.currentTarget).attr('id')];\n      this.index = $(e.currentTarget).attr('id');\n      this.notNew = false;\n      this.cipher = null;\n      this.oninit(this.vnode);\n      m.redraw();\n    }));\n\n    $('#MessageTextArea').off().on('keydown', (e) => {\n      if (e.keyCode === 13 && app.forum.attribute('whisperReturnKey')) {\n        $('#MessageTextArea').prop(\"disabled\", true);\n        this.sendMessage();\n      }\n    });\n  }\n\n  oncreate() {\n\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        channels.user.bind('newMessage', data => {\n          if (parseInt(data.conversationId) === parseInt(this.conversation.id()) && $('.MessagesDropdown').children('.Dropdown-menu').is(':visible')) {\n            const message = {\n              id: Stream(data.id),\n              message: Stream(data.message),\n              user: Stream(this.user),\n              createdAt: Stream(data.createdAt)\n            };\n            this.decryptMessages([message]);\n            this.newMessageCount++;\n            this.typing = false;\n            m.redraw();\n            $(\".chat-history\").animate({scrollTop: $('.chat-history').prop(\"scrollHeight\")}, 1000);\n          }\n        });\n\n        channels.user.bind('typing', data => {\n          if (parseInt(data.conversationId) === parseInt(this.conversation.id())) {\n            let list = $(\".chat-history\");\n\n            let scrollMore = false;\n\n            if (list.scrollTop() + list.innerHeight() >= list[0].scrollHeight - 50) {\n              scrollMore = true;\n            }\n\n            this.typing = true;\n            this.typingTime = new Date();\n            m.redraw();\n\n            if (scrollMore) {\n              list.animate({scrollTop: $('.chat-history').prop(\"scrollHeight\")}, 400);\n            }\n          }\n        })\n\n        channels.user.bind('readMessage', data => {\n          if (parseInt(data.conversationId) === parseInt(this.conversation.id())) {\n\n            this.recipient.lastRead = m.prop(data.number);\n            m.redraw();\n          }\n        })\n      })\n    }\n  }\n\n  view() {\n    this.messages = app.cache.messages ? app.cache.messages[this.conversation.id()] : [];\n    return (\n      <div style={this.idParam && this.mobile ? 'width: 100%' : ''} className=\"chat\">\n        <div className=\"chat-header clearfix\">\n          {avatar(this.user)}\n\n          <div className=\"chat-about\">\n            <div\n              className=\"chat-with\">{app.translator.trans('kyrne-whisper.forum.chat.chat_with', {username: username(this.user)})}</div>\n            <div\n              className=\"chat-num-messages\">{app.translator.trans('kyrne-whisper.forum.chat.messages_' + (parseInt(this.conversation.totalMessages()) > 1 ? 'multiple' : 'single'), {count: this.conversation.totalMessages() + this.newMessageCount})}</div>\n          </div>\n        </div>\n\n        {this.messages && this.messages.length > 0 && !this.loading ? [\n          <div className=\"chat-history\">\n            <ul>\n              {this.notNew ?\n                <li className=\"startConvo\">{app.translator.trans('kyrne-whisper.forum.chat.start_of_conversation')}</li>\n                : ''}\n              {this.messages ? this.messages.filter((message, index, self) =>\n                index === self.findIndex((t) => (\n                  t.message() === message.message()\n                ))\n              ).sort((a, b) => {\n                return a.createdAt() - b.createdAt();\n              }).map((message, i) => {\n                const myMessage = parseInt(message.user().id()) === parseInt(app.session.user.id());\n                return (\n                  <li className=\"clearfix message-content\">\n                    <div className={\"message-data \" + (myMessage ? 'align-right' : '')}>\n                      <div className={\"avatar-inline \" + (myMessage ? 'me' : 'other')}>\n                        {avatar(myMessage ? app.session.user : message.user())}\n                      </div>\n                      <span\n                        className=\"message-data-name\">{username(myMessage ? app.session.user : message.user())}</span>\n                      <span className=\"message-data-time\">{humanTime(message.createdAt())}</span>\n\n                    </div>\n                    <MessageText content={message.message()}\n                                 className={\"message \" + (myMessage ? 'my-message float-right' : 'other-message')}></MessageText>\n                    {myMessage ? ((parseInt(this.recipient.lastRead()) >= parseInt(message.data.attributes.number)) ? <span className=\"message-read\">{icon('fas fa-check')}</span> : '') : ''}\n                  </li>\n                )\n\n              }) : ''}\n              {this.messageContent() ?\n                <li>\n                  <MessageText content={this.messageContent()}\n                               className={\"message my-message float-right message-preview\"}\n                               preview={true}></MessageText>\n                </li>\n                : ''\n              }\n              {this.typing ?\n                <li>\n                  <div className=\"tiblock\">\n                    <div className=\"tidot\"></div>\n                    <div className=\"tidot\"></div>\n                    <div className=\"tidot\"></div>\n                  </div>\n                </li>\n                : ''}\n            </ul>\n\n          </div>\n        ] : <LoadingIndicator display=\"block\" size=\"medium\" />}\n\n\n        <form className=\"chat-message clearfix\">\n                <textarea id=\"MessageTextArea\" value={this.messageContent()}\n                          oninput={withAttr('value', this.typingPush.bind(this))}\n                          placeholder={app.translator.trans('kyrne-whisper.forum.chat.text_placeholder')}\n                          rows=\"3\"></textarea>,\n\n          {Button.component({\n              onclick: this.sendMessage.bind(this),\n              className: 'Button Button--primary',\n              disabled: !this.messageContent() || !this.sendTimeout,\n            }, app.translator.trans('kyrne-whisper.forum.chat.send')\n          )}\n        </form>\n      </div>\n    )\n  }\n\n  typingPush(value) {\n    this.messageContent(value);\n    m.redraw();\n    if (this.typingTimeout) {\n      app.request({\n        method: 'POST',\n        url: app.forum.attribute('apiUrl') + '/whisper/messages/typing',\n        body: {\n          conversationId: this.conversation.id(),\n          userId: this.user.id()\n        }\n      }).then(() => {\n        this.typingTimeout = false;\n      });\n    }\n  }\n\n  sendMessage() {\n    if (this.sendTimeout) {\n      if (this.messageContent() === '' || !this.messageContent().replace(/\\s/g, '').length) return;\n      this.sendTimeout = false;\n      this.timer = 1;\n      this.interval3();\n      this.newMessageCount++;\n      app.store.createRecord('messages')\n        .save({\n          messageContents: this.messageContent(),\n          conversationId: this.conversation.id()\n        }).then(message => {\n        app.cache.messages[this.conversation.id()].push(message);\n        m.redraw();\n        this.messageContent('');\n        $(\".chat-history\").animate({scrollTop: $('.chat-history').prop(\"scrollHeight\")}, 500);\n        app.request({\n          method: 'POST',\n          url: app.forum.attribute('apiUrl') + '/whisper/messages/read',\n          body: {\n            conversationId: this.conversation.id(),\n            messageId: message.id()\n          }\n        })\n      })\n    }\n  }\n\n  getMessages(offset = 0) {\n    if (!this.notNew) {\n      app.store.find('whisper/messages', this.conversation.id(), {offset})\n        .then(results => {\n          delete results.payload;\n          if (this.firstLoad) {\n            const oldNumber = this.meRecipient.lastRead();\n            app.request({\n              method: 'POST',\n              url: app.forum.attribute('apiUrl') + '/whisper/messages/read',\n              body: {\n                conversationId: this.conversation.id(),\n                messageId: results[0].id()\n              }\n            }).then((response) => {\n              const newNumber = response.data.attributes.lastRead;\n              app.session.user.pushAttributes({\n                unreadMessages: app.session.user.unreadMessages() - (newNumber - oldNumber),\n              });\n              m.redraw();\n              this.firstLoad = false;\n            })\n          }\n          app.cache.messages[this.conversation.id()].push(...results);\n          if (results.length < 20) {\n            this.notNew = true;\n          }\n        })\n        .then(() => {\n          this.loading = false;\n          m.redraw();\n        });\n    }\n  }\n\n  load() {\n    this.loading = true;\n    m.redraw();\n\n    if (!app.cache.messages) {\n      app.cache.messages = [];\n    }\n\n    this.conversation.recipients().map(recipient => {\n      if (parseInt(recipient.user().id()) !== parseInt(app.session.user.id())) {\n        this.user = recipient.user();\n        this.recipient = recipient;\n      } else {\n        this.meRecipient = recipient;\n      }\n    });\n\n\n    if (!app.cache.messages[this.conversation.id()]) {\n      app.cache.messages[this.conversation.id()] = [];\n    }\n\n    this.getMessages();\n  }\n}\n","import Component from 'flarum/Component';\nimport avatar from 'flarum/helpers/avatar';\nimport username from 'flarum/helpers/username';\nimport userOnline from 'flarum/helpers/userOnline';\n\n\nexport default class UserListItem extends Component {\n  oninit(vnode) {\n    this.conversation = vnode.attrs.conversation;\n    this.index = vnode.attrs.i;\n    this.active = vnode.attrs.active;\n    this.loading = true;\n\n    this.conversation.recipients().map(recipient => {\n      if (parseInt(recipient.user().id()) !== parseInt(app.session.user.id())) {\n        this.user = recipient.user();\n        this.loading = false;\n        m.redraw();\n      }\n    });\n\n    const interval2 = () => {\n      if (this.typingTime < new Date(Date.now() - 6000)) {\n        this.typing = false;\n        m.redraw();\n      }\n      setTimeout(() => {\n        interval2();\n      }, 6000);\n    };\n\n    interval2();\n  }\n\n  onremove() {\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        channels.user.unbind('typing');\n      });\n    }\n  }\n\n  onupdate() {\n    $('.UserListItem').on('click tap', ((e) => {\n        this.active = this.conversation.id() == app.cache.conversations[$(e.currentTarget).attr('id')].id();\n        m.redraw();\n    }));\n\n  }\n\n  oncreate() {\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        channels.user.bind('typing', data => {\n          if (parseInt(data.conversationId) === parseInt(this.conversation.id())) {\n            this.typing = true;\n            this.typingTime = new Date();\n            m.redraw();\n          }\n        })\n      })\n    }\n  }\n\n  view() {\n    if (this.loading) return;\n    return (\n      <li id={this.index} className={this.active ? 'UserListItem active' : 'UserListItem'}>\n        <div className=\"UserListItem-content\">\n          {avatar(this.user)}\n          <div className=\"info\">\n            {username(this.user)}\n            {userOnline(this.user)}\n          </div>\n          {this.typing ?\n            <div className=\"tiblock\">\n              <div className=\"tidot\"></div>\n            </div>\n            : ''}\n        </div>\n      </li>\n    )\n  }\n}\n\n","import highlight from 'flarum/helpers/highlight';\nimport avatar from 'flarum/helpers/avatar';\nimport username from 'flarum/helpers/username';\n\nexport default class UserSearchSource {\n  view(query) {\n    if (query.length < 3 || this.loading) return;\n\n    if (!app.cache.conversationResults) {\n      app.cache.conversationResults = [];\n    }\n\n    this.query = query;\n\n    if (!app.cache.conversationResults[this.query]) {\n\n      this.loading = true;\n\n      app.cache.conversationResults[this.query] = [];\n      app.store.find('users', {\n        filter: {q: this.query},\n        page: {limit: 5}\n      }).then(this.pushResults.bind(this));\n    } else\n\n      return [\n        <li className=\"Dropdown-header\">{app.translator.trans('core.forum.search.users_heading')}</li>,\n        app.cache.conversationResults[this.query].map(user => {\n          let name = username(user);\n          name = highlight(name.text, this.query);\n\n          return (\n            <li className='SearchResult' data-index={user.id()}>\n              <a data-index={'users:' + user.id()}>\n                {avatar(user)}\n                {name}\n              </a>\n            </li>\n          );\n        })\n      ];\n  }\n\n  pushResults(results) {\n    results.payload.data.map(result => {\n      let user = app.store.getById('users', result.id);\n      if (parseInt(user.id()) !== parseInt(app.session.user.id())) {\n        app.cache.conversationResults[this.query].push(user);\n      }\n    });\n    this.loading = false;\n    m.redraw();\n  }\n}\n","import Search from \"flarum/components/Search\";\nimport UserSearchSource from \"./UserSearchSource\";\nimport ItemList from \"flarum/utils/ItemList\";\nimport classList from \"flarum/utils/classList\";\nimport extractText from \"flarum/utils/extractText\";\nimport LoadingIndicator from \"flarum/components/LoadingIndicator\";\nimport recipientLabel from \"./recipientLabel\";\nimport Stream from 'flarum/utils/Stream';\nimport withAttr from 'flarum/utils/withAttr';\n\nexport default class RecipientSearch extends Search {\n\n  oninit(attrs) {\n    this.value = Stream();\n    super.oninit(attrs);\n  }\n\n  onupdate(vnode) {\n\n\n    const $search = this;\n\n    this.$('.Search-results').on('click', (e) => {\n      const target = this.$('.SearchResult.active')\n\n      $search.addRecipient(target.data('index'));\n      $search.$('.RecipientsInput').focus();\n    });\n\n    this.$('.Search-results').on('touchstart', (e) => {\n      const target = this.$(e.target.parentNode);\n\n      $search.addRecipient(target.data('index'));\n      $search.$('.RecipientsInput').focus();\n    });\n\n    $('.RecipientsInput').on('keyup', () => {\n      clearTimeout(this.typingTimer);\n      this.doSearch = false;\n      this.typingTimer = setTimeout(() => {\n        this.doSearch = true;\n        m.redraw();\n      }, 900);\n    }).on('keydown', () => {\n      clearTimeout(this.typingTimer);\n    });\n\n    super.oncreate(vnode);\n  }\n\n  view() {\n    if (typeof this.value() === 'undefined') {\n      this.value('');\n    }\n\n    const loading = this.value() && this.value().length >= 3;\n\n    if (!this.sources) {\n      this.sources = this.sourceItems().toArray();\n    }\n\n    return (\n      <div className=\"AddRecipientModal-body\">\n        {app.cache.conversationsRecipient === null ?\n          <div className=\"AddRecipientModal-form-input\">\n            <input className={'RecipientsInput FormControl ' + classList({\n              open: !!this.value(),\n              focused: !!this.value(),\n              active: !!this.value(),\n              loading: !!this.loadingSources\n            })}\n                   config={function (element) {\n                     element.focus();\n                   }}\n                   type=\"search\"\n                   placeholder={extractText(app.translator.trans('kyrne-whisper.forum.modal.search_recipients'))}\n                   value={this.value()}\n                   oninput={withAttr('value', this.value)}\n                   onfocus={() => this.hasFocus = true}\n                   onblur={() => this.hasFocus = false}\n            />\n            <ul className={\n              'Dropdown-menu Search-results fade ' + classList({\n                in: !!loading\n              })\n            }>\n              {!this.doSearch\n                ? LoadingIndicator.component({size: 'tiny', className: 'Button Button--icon Button--link'})\n                : this.sources.map(source => source.view(this.value()))}\n                <li>\n                  <span>{app.translator.trans('kyrne-whisper.forum.modal.more_users')}</span>\n                </li>\n            </ul>\n          </div>\n          : <div className=\"RecipientsInput-selected RecipientsLabel\">\n            {recipientLabel(app.cache.conversationsRecipient, {\n              onclick: () => {\n                this.removeRecipient(app.cache.conversationsRecipient);\n              }\n            })}\n          </div>\n        }\n      </div>\n    )\n  }\n\n  /**\n   * Build an item list of SearchSources.\n   *\n   * @return {ItemList}\n   */\n  sourceItems() {\n    const items = new ItemList();\n\n    items.add('users', new UserSearchSource());\n\n    return items;\n  }\n\n\n  /**\n   * Clear the search input and the current controller's active search.\n   */\n  clear() {\n    this.value('');\n\n    m.redraw();\n  }\n\n  /**\n   * Adds a recipient.\n   *\n   * @param value\n   */\n  addRecipient(value) {\n    app.cache.conversationsRecipient = app.store.getById('users', value);\n\n    this.clear();\n  }\n\n  /**\n   * Removes a recipient.\n   *\n   * @param recipient\n   */\n  removeRecipient(recipient) {\n    app.cache.conversationsRecipient = null;\n\n    m.redraw();\n  }\n\n  /**\n   * Loads a recipient from the global store.\n   *\n   * @param store\n   * @param id\n   * @returns {Model}\n   */\n  findRecipient(store, id) {\n    return app.store.getById(store, id);\n  }\n}\n","import extract from 'flarum/utils/extract';\nimport avatar from 'flarum/helpers/avatar';\nimport username from 'flarum/helpers/username';\n\n\nexport default function recipientLabel(recipient, attrs = {}) {\n  attrs.style = attrs.style || {};\n  attrs.className = 'RecipientLabel ' + (attrs.className || '');\n\n  const link = extract(attrs, 'link');\n\n  return (\n    m((link ? 'a' : 'span'), attrs,\n      <span className=\"RecipientLabel-text\">\n                {avatar(recipient)}\n              {username(recipient)}\n        </span>\n    )\n  );\n}","import Modal from \"flarum/components/Modal\";\nimport Button from \"flarum/components/Button\";\nimport RecipientSearch from \"./RecipientSearch\";\nimport username from 'flarum/helpers/username';\nimport Stream from 'flarum/utils/Stream';\nimport withAttr from 'flarum/utils/withAttr';\n\nexport default class StartConversationModal extends Modal {\n\n  oninit(vnode) {\n    super.oninit(vnode);\n\n    app.cache.conversationsRecipient = null;\n\n    this.conversations = this.attrs.conversations;\n\n    this.already = false;\n\n    this.messageContent = Stream('');\n  }\n\n  title() {\n    return app.translator.trans('kyrne-whisper.forum.modal.title');\n  }\n\n  className() {\n    return 'StartConversationModal Modal--medium';\n  }\n\n  onbeforeupdate() {\n    $('.Modal-content').on('click tap', (ev) => {\n      ev.stopImmediatePropagation();\n    })\n  }\n\n  content() {\n    return [\n      <div className=\"Modal-body\">\n        {this.already ? [\n          <h2>{app.translator.trans('kyrne-whisper.forum.modal.already', {username: username(this.recpient)})}</h2>,\n          <h2>{app.translator.trans('kyrne-whisper.forum.modal.copied', {username: username(this.recpient)})}</h2>\n          ] :\n          <div>\n            <div class=\"helpText\">\n              {app.cache.conversationsRecipient !== null ? app.translator.trans('kyrne-whisper.forum.modal.help_start', {username: username(app.cache.conversationsRecipient)}) : app.translator.trans('kyrne-whisper.forum.modal.help')}\n            </div>\n            <div className=\"AddRecipientModal-form\">\n              <RecipientSearch state={app.search} ></RecipientSearch>\n              {app.cache.conversationsRecipient !== null ?\n                <div className=\"AddRecipientModal-form-submit\">\n                  <textarea value={this.messageContent()} oninput={withAttr('value', this.messageContent)} placeholder={app.translator.trans('kyrne-whisper.forum.chat.text_placeholder')} rows=\"3\"></textarea>\n                  {Button.component({\n                    type: 'submit',\n                    className: 'Button Button--primary',\n                    disabled: !this.messageContent(),\n                  }, app.translator.trans('kyrne-whisper.forum.modal.submit')\n                  )}\n                </div>\n                : ''}\n            </div>\n          </div>\n        }\n      </div>\n    ];\n  }\n\n  onsubmit(e) {\n    e.preventDefault();\n\n    const recipient = app.cache.conversationsRecipient;\n    this.recpient = recipient;\n    app.cache.conversationsRecipient = null;\n\n    app.store.createRecord('conversations')\n      .save({\n        messageContents: this.messageContent(),\n        recipient: recipient.id(),\n      }).then(conversation => {\n      if (!conversation.notNew()) {\n        this.conversations.push(conversation);\n        const preconv = app.session.user.conversations();\n        preconv.push(conversation);\n        app.session.user.conversations = Stream(preconv);\n        m.redraw();\n        app.modal.close();\n      } else {\n        let input = document.createElement('textarea');\n        document.body.appendChild(input);\n        input.value = this.messageContent();\n        input.focus();\n        input.select();\n        document.execCommand('Copy');\n        input.remove();\n        this.already = true;\n        m.redraw();\n      }\n    })\n  }\n}\n","import Button from 'flarum/components/Button';\nimport Component from 'flarum/Component';\nimport ConversationView from './ConversationView';\nimport UserListItem from './UserListItem';\nimport StartConversationModal from './StartConversationModal';\n\nexport default class ConversationsList extends Component {\n  oninit(vnode) {\n    this.mobile = vnode.attrs.mobile;\n    this.load();\n    this.loading = false;\n    this.currentConversation = null;\n  }\n\n  onupdate() {\n    $('.UserListItem').on('click tap', ((e) => {\n      if (this.mobile) {\n        m.route(app.route('messages', {id: app.cache.conversations[$(e.currentTarget).attr('id')].id()}))\n      } else {\n        this.currentConversation = app.cache.conversations[$(e.currentTarget).attr('id')];\n        m.redraw();\n      }\n    }));\n\n  }\n\n  onbeforeupdate() {\n\n    let list = $('.ConversationsList-list');\n\n    list.scroll(() => {\n      if (list.scrollTop() + list.innerHeight() >= list[0].scrollHeight) {\n        this.loadMore()\n      }\n    });\n  }\n\n  view() {\n    if (this.loading) return;\n    const conversations = app.cache.conversations;\n\n    if (this.currentConversation === null && app.cache.conversations && app.cache.conversations.length > 0) {\n      this.currentConversation = app.cache.conversations[0];\n    }\n\n    if (this.currentConversation) {\n      this.conversationComponent = ConversationView.component({conversation: this.currentConversation, mobile: this.mobile});\n    }\n\n    return (\n      <div className=\"ConversationsList\">\n        <div style={app.session.user.conversations().length ? '' : 'width: unset; padding: 10px;'} className=\"container clearfix\">\n          <div style={this.mobile ? 'float: unset; margin: 0 auto; display: block;' : ''} className=\"people-list\" id=\"people-list\">\n            {Button.component({\n              onclick: this.showModal.bind(this),\n              className: 'Button Button--primary',\n              disabled: !app.forum.attribute('canMessage'),\n            }, app.forum.attribute('canMessage') ? app.translator.trans('kyrne-whisper.forum.chat.start') : app.translator.trans('kyrne-whisper.forum.chat.cant_start')\n            )}\n            {app.session.user.conversations().length ?\n            <ul className=\"ConversationsList-list\">\n              {conversations ? conversations.map((conversation, i) => {\n                return UserListItem.component({conversation, i, active: this.mobile ? false : this.currentConversation === conversation})\n              }) : ''}\n            </ul>\n              : ''}\n          </div>\n\n          {!this.mobile ? this.conversationComponent : ''}\n\n        </div>\n      </div>\n\n    );\n  }\n\n  showModal() {\n    app.modal.show(StartConversationModal, {\n      conversations: app.cache.conversations,\n      messages: app.cache.messages\n    })\n  }\n\n  loadMore() {\n    this.loading = true;\n    m.redraw();\n\n    app.store.find('whisper/conversations', {offset: app.cache.conversations.length})\n      .then(results => {\n        delete results.payload;\n        results.map(result => {\n          app.cache.conversations.push(result)\n        });\n      })\n      .catch(() => {\n      })\n      .then(() => {\n        this.loading = false;\n        m.redraw();\n      });\n  }\n\n  load() {\n    if (app.cache.conversations && !this.mobile) {\n      return;\n    }\n\n    if (this.mobile) {\n      app.cache.conversations = [];\n    }\n\n    this.loading = true;\n    m.redraw();\n\n    app.store.find('whisper/conversations')\n      .then(results => {\n        delete results.payload;\n        app.cache.conversations = results;\n      })\n      .catch(() => {\n      })\n      .then(() => {\n        this.loading = false;\n        m.redraw();\n      });\n  }\n}\n","import Page from 'flarum/components/Page';\n\nimport ConversationsList from './ConversationsList';\n\nexport default class ConversationsPage extends Page {\n  oninit() {\n    super.oninit();\n\n    app.history.push('messages');\n\n    this.bodyClass = 'App--conversations';\n  }\n\n  view() {\n    return <div className=\"ConversationsPage\"><ConversationsList mobile={true}></ConversationsList></div>;\n  }\n}\n","import Page from 'flarum/components/Page';\n\nimport ConversationView from './ConversationView';\n\nexport default class ConversationViewPage extends Page {\n  init() {\n    super.init();\n\n    app.history.push('conversations');\n\n    const idParam = m.route.param('id');\n\n    app.store.find('whisper/conversations', idParam)\n      .then(conversation => {\n        app.cache.conversations = [];\n        app.cache.conversations.push(conversation);\n        this.list = ConversationView.component({conversation, mobile: true});\n        m.redraw();\n      });\n\n\n    this.bodyClass = 'App--messages';\n  }\n\n  view() {\n    return (\n      <div className=\"MessagesPage\">\n        <div className=\"ConversationsList\">\n          <div className=\"container clearfix\">\n            {this.list ? this.list : null}\n          </div>\n        </div>\n      </div>\n    );\n  }\n}","import NotificationsDropdown from 'flarum/components/NotificationsDropdown';\n\nimport ConversationsList from './ConversationsList';\n\nexport default class ConversationsDropdown extends NotificationsDropdown {\n  static initAttrs(attrs) {\n    attrs.label = attrs.label || app.translator.trans('kyrne-whisper.forum.dropdown.tooltip');\n    attrs.icon = attrs.icon || 'fas fa-comment-alt';\n    attrs.className = 'MessagesDropdown NotificationsDropdown';\n\n    super.initAttrs(attrs);\n  }\n\n  onclick() {\n    if (app.drawer.isOpen()) {\n      this.goToRoute();\n    }\n\n  }\n\n  getMenu() {\n    return (\n      <form className={'Dropdown-menu ' + this.attrs.menuClassName}>\n        {this.showing ? <ConversationsList mobile={false}></ConversationsList> : ''}\n      </form>\n    );\n  }\n\n  goToRoute() {\n    m.route(app.route('conversations'));\n  }\n\n  getUnreadCount() {\n    return app.session.user.unreadMessages();\n  }\n\n  getNewCount() {\n    return app.session.user.unreadMessages();\n  }\n}\n","import app from 'flarum/app';\nimport {extend} from 'flarum/extend';\nimport IndexPage from 'flarum/components/IndexPage';\nimport Message from './models/Message';\nimport Conversation from './models/Conversation';\nimport ConversationUser from './models/ConversationUser';\nimport User from 'flarum/models/User';\nimport Model from 'flarum/Model';\nimport ConversationsPage from './components/ConversationsPage';\nimport ConversationViewPage from './components/ConversationViewPage';\nimport Stream from 'flarum/utils/Stream';\n\nimport addConversationsDropdown from './addConversationsDropdown'\n\napp.initializers.add('kyrne-whisper', function (app) {\n  app.store.models.messages = Message;\n  app.store.models.conversations = Conversation;\n  app.store.models.conversation_users = ConversationUser;\n\n  User.prototype.conversations = Model.hasMany('conversations');\n  User.prototype.unreadMessages = Model.attribute('unreadMessages');\n\n  app.routes.conversations = { path: '/whisper/conversations', component: ConversationsPage };\n  app.routes.messages = { path: '/whisper/messages/:id', component: ConversationViewPage };\n\n  addConversationsDropdown();\n\n  extend(IndexPage.prototype, 'oncreate', function() {\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        if (channels.user) {\n          channels.user.bind('newMessage', data => {\n            app.session.user.unreadMessages = Stream(app.session.user.unreadMessages() + 1);\n            m.redraw();\n          });\n        }\n      });\n    }\n  })\n\n  extend(IndexPage.prototype, 'onremove', function() {\n    if (app.pusher) {\n      app.pusher.then(object => {\n        const channels = object.channels;\n        if (channels.user) {\n          channels.user.unbind('newMessage');\n        }\n      });\n    }\n  })\n});\n","import { extend } from 'flarum/extend';\nimport app from 'flarum/app';\nimport HeaderSecondary from 'flarum/components/HeaderSecondary';\nimport ConversationsDropdown from './components/ConversationsDropdown';\n\nexport default function() {\n    extend(HeaderSecondary.prototype, 'items', function(items) {\n        if ((app.forum.attribute('canMessage') || (app.session.user && app.session.user.conversations().length))) {\n            items.add('Messages', <ConversationsDropdown/>, 20);\n        }\n    });\n}\n"],"sourceRoot":""}